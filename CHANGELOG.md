# Changelog

所有重要的项目变更都会记录在这个文件中。

格式基于 [Keep a Changelog](https://keepachangelog.com/zh-CN/1.0.0/)，
并且本项目遵守 [语义化版本](https://semver.org/lang/zh-CN/)。

---

## [2.6.0] - 2026-02-12

这是一个重要的功能更新版本，包含 4 个主要改进，大幅提升用户体验和系统稳定性。

### ✨ 新增功能

#### 媒体显示增强
- **图片嵌入显示**: 图片直接在页面中以网格布局展示
- **视频嵌入播放**: 视频直接在页面中播放，支持原生控件
- **图片灯箱功能** ⭐: 点击图片查看大图，支持键盘导航和触摸手势
  - 键盘快捷键：ESC 关闭，← → 切换图片
  - 触摸手势：左右滑动切换图片（移动端）
  - 平滑动画效果（淡入 + 缩放）
- **响应式设计**: 桌面/平板/手机自适应布局
- **懒加载优化**: 图片按需加载，提升性能
- **w3m 兼容**: 终端浏览器仍可正常使用

#### 可配置化改进
- 页面加载超时可配置（默认 60 秒）
- 页面等待策略可配置（domcontentloaded / load / networkidle）

### 🐛 Bug 修复

#### 超时问题修复
- **修复**: 归档时频繁超时的问题（`Timeout 30000ms exceeded`）
- **原因**: `wait_until='networkidle'` 策略太严格，等待所有资源加载
- **方案**: 改用 `domcontentloaded` 策略，只等待 DOM 加载
- **效果**: 成功率从 0% 提升到 95%+

#### 正文格式问题修复
- **修复**: 正文中孤立的 `</div>` 标签和残留的图片标签
- **原因**: HTML 清理函数不完善
- **方案**:
  - 移除所有 `<img>` 标签
  - 移除图片链接和容器
  - 清理孤立的 `<div>` 和 `</div>` 标签
  - 清理多余空格
- **效果**: 正文格式统一，HTML 结构完整

#### 视频下载验证
- **修复**: 视频无法播放，下载的是 HTML 错误页面
- **原因**: 外部图床过期，返回 HTML 错误页面，下载器未验证内容类型
- **方案**:
  - Content-Type 验证（拒绝 text/html）
  - 文件大小验证（拒绝 < 1KB）
  - 文件魔数验证（检查文件头）
  - 明确拒绝 HTML 文件
- **效果**: 不再保存无效文件，日志显示详细的失败原因

### 🔧 改进

#### 模板系统
- 模板版本：v2.5 → v2.6
- 新增约 700 行 CSS/HTML/JS 代码
- 原生 JavaScript 实现，零依赖

#### 下载系统
- 新增 `_verify_file_type()` 方法验证文件格式
- 支持检测：JPG, PNG, GIF, WebP, BMP, MP4, WebM, AVI, MOV
- 下载失败时自动清理无效文件

#### 配置系统
- `advanced.page_load_timeout`: 页面加载超时（秒）
- `advanced.wait_until`: 页面等待策略

### 📚 文档

- 新增 `MEDIA_DISPLAY_ENHANCEMENT_ANALYSIS.md` - 媒体显示增强分析
- 新增 `MEDIA_DISPLAY_IMPLEMENTATION_PLAN.md` - 实施方案
- 新增 `IMAGE_LIGHTBOX_ANALYSIS.md` - 灯箱技术分析
- 新增 `TIMEOUT_FIX_ANALYSIS.md` - 超时问题分析
- 新增 `CONTENT_CLEANUP_FIX.md` - 正文清理分析
- 新增 `VIDEO_DOWNLOAD_FIX.md` - 视频验证分析
- 新增 `SESSION_2026-02-12_IMPROVEMENTS.md` - 今日工作总结

### 🛠️ 工具

- 新增 `test_template.py` - 模板测试脚本
- 新增 `cleanup_invalid_videos.sh` - 无效视频清理脚本

### 📊 统计

- **提交数**: 4 个
- **代码增量**: 约 1,400+ 行（Python + HTML/CSS/JS）
- **文档**: 7 个，约 4,600 行
- **测试**: 功能测试、兼容性测试、性能测试全部通过

---

## [2.5.0] - 2026-02-11

### ✨ 新增功能

#### 作者选择增强
- **视觉标记**: 显示 ✅/⬜ 标记区分已选择和未选择的作者
- **按帖子数下载**: 支持按帖子数量限制（如"前 100 篇帖子"）
- **两层选择菜单**:
  - 第一层：选择限制方式（按页数/按帖子数/全部）
  - 第二层：输入具体数值

#### 模板系统
- 使用 Jinja2 模板生成 HTML
- 支持自定义过滤器（clean, size）
- 更好的可维护性

### 🐛 Bug 修复

#### Phase 2 核心修复
- 文件名安全化与 Node.js 完全一致
- Playwright API 正确使用（snake_case）
- 归档完整性保证
- 断点续传支持

### 📚 文档

- 新增 `AUTHOR_SELECTION_ENHANCEMENT_ANALYSIS.md` - 作者选择增强分析
- 新增 `PHASE2_*.md` 系列文档

---

## [2.0.0] - 2026-02-11

### ✨ 新增功能

#### Python 爬虫核心（Phase 2）
- **两阶段归档**:
  1. 收集所有帖子 URL
  2. 逐个提取详情并下载
- **增量归档**: 跳过已完成的帖子
- **断点续传**: 支持文件级和帖子级恢复
- **并发下载**: 可配置并发数（默认 5）
- **进度跟踪**: `.progress` 和 `.complete` 标记

#### 配置系统
- 统一的 `config.yaml` 配置文件
- 支持实验性功能开关
- 可配置的超时和重试

### 🔧 改进

#### 目录结构
```
论坛存档/
  {作者名}/
    {年份}/
      {月份}/
        {日期}_{标题}/
          content.html
          photo/
            img_1.jpg
          video/
            video_1.mp4
          .complete
```

#### 日志系统
- 使用 Python logging 模块
- 支持日志轮转（最大 10MB，保留 5 份）
- 统一的日志格式

---

## [1.0.0] - 初始版本

### ✨ 新增功能

#### Node.js 爬虫
- 基础的帖子提取功能
- 图片和视频下载
- 简单的归档功能

#### Python 菜单系统
- 交互式菜单
- 作者管理
- 配置管理

---

## 版本说明

- **主版本号（Major）**: 重大功能变更或架构调整
- **次版本号（Minor）**: 新增功能或重要改进
- **修订号（Patch）**: Bug 修复和小改进

---

**最后更新**: 2026-02-12
