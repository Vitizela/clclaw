# ADR-001: 论坛作者帖子的自动化订阅、抓取与归档系统

**状态**: 已修订 (Revised)

**日期**: 2026-02-12

---

## 1. 背景 (Context)

此 ADR 取代了 `2026-02-11` 的初始版本。

最初的方案是一个一次性的批处理流程：用户提供版块链接，系统提取作者列表供用户选择，然后一次性抓取所选作者的所有帖子。

在讨论中，用户提出了一个更高级的需求：将系统转变为一个**可持续的、基于“订阅”的自动化内容追踪系统**。用户希望能够通过提供单个帖子链接来“关注”某个作者，然后系统能自动完成该作者的**历史帖子全量归档**，并在未来通过**定时任务自动进行增量更新**，只抓取新发布的帖子。

## 2. 决策 (Decision)

我们将采用一个全新的、基于配置文件的订阅模式来构建此自动化系统。技术栈核心依然是 **Playwright** 和 **Node.js**，但工作流将围绕一个持久化的 `config.json` 文件来展开。

该系统将由三个核心脚本和一个配置文件组成：

1.  **配置文件 (`config.json`)**: 作为系统的“大脑”，持久化存储用户“关注”的作者列表和目标论坛版块 URL。
2.  **订阅脚本 (`follow_author.js`)**: 用户交互的入口。接收一个帖子 URL，自动提取作者名并将其添加到 `config.json` 的关注列表中，然后立即触发对该作者的全量历史帖子归档。
3.  **核心归档脚本 (`archive_posts.js`)**: 系统的核心执行单元。负责接收作者列表，扫描论坛，并以**增量模式**（跳过已存在的帖子）下载和整理帖子。
4.  **定时调度脚本 (`run_scheduled_update.js`)**: 用于自动化执行。它读取 `config.json` 中的所有关注作者，并调用核心归档脚本来为他们检查和下载更新。此脚本可由系统的定时任务（如 Cron Job）定期触发。

## 3. 技术实现细则 (Implementation Specification)

**3.1. 配置文件 (`config.json`)**
*   **位置**: 项目根目录。
*   **结构**:
    ```json
    {
      "forumSectionUrl": "https://t66y.com/thread0806.php?fid=7",
      "followedAuthors": [
        "作者A",
        "作者B"
      ]
    }
    ```

**3.2. 订阅脚本 (`follow_author.js`)**
*   **输入**: (命令行参数) `postUrl` - 一个帖子的 URL。
*   **核心逻辑**:
    1.  读取 `config.json`。
    2.  使用 Playwright 访问 `postUrl`，提取作者名。
    3.  如果作者名不在 `followedAuthors` 数组中，则添加并保存 `config.json`。
    4.  使用 Node.js 的 `child_process` 模块，**立即调用 `archive_posts.js` 脚本**，并将新关注的作者名作为参数传入，完成首次全量归档。

**3.3. 核心归档脚本 (`archive_posts.js`)**
*   **输入**: (命令行参数) `authorsToScrape` - 一个或多个作者名的数组。
*   **核心逻辑**:
    1.  读取 `config.json` 获取 `forumSectionUrl`。
    2.  **搜集帖子链接**: 遍历论坛所有页面，收集 `authorsToScrape` 名单上所有作者发布的帖子链接。
    3.  **逐一处理帖子**: 对每个帖子链接：
        a.  **提取数据**: 提取标题、作者、发布日期 (从 `span[data-timestamp]` 获取以确保精确)。
        b.  **生成预期路径**: 根据 `作者/年份/月份/安全处理后的标题` 规则，生成帖子的目标归档目录路径。
        c.  **增量检查**: 使用 `fs.existsSync()` 检查该目录是否已存在。如果存在，则**跳过**此帖子的所有后续处理。
        d.  **归档新帖子**: 如果目录不存在，则执行完整的归档流程（创建目录结构、下载图片/视频、清理HTML、保存为 `.md` 文件）。
    *   **关键技术点**:
        *   **CSS选择器**: 使用 `#tbody .bl` 精确定位作者。
        *   **超时设置**: 所有 Playwright 页面交互和等待操作，均设置 `timeout: 60000`。

**3.4. 定时调度脚本 (`run_scheduled_update.js`)**
*   **核心逻辑**:
    1.  读取 `config.json` 获取 `followedAuthors` 列表。
    2.  如果列表不为空，则调用 `archive_posts.js` 脚本，并将整个列表作为参数传入。

**3.5. 自动化调度**
*   **方式**: 使用操作系统的定时任务功能（Linux/macOS 下为 `cron`）。
*   **示例 Cron Job**: 设置为每天凌晨3点运行。
    ```cron
    0 3 * * * cd /path/to/project && /usr/bin/node run_scheduled_update.js
    ```

## 4. 后果 (Consequences)

**正面**:
*   **可持续自动化**: 系统从一次性任务演变为可持续、无人值守的订阅系统。
*   **高效增量更新**: 通过检查目录是否存在来实现增量归档，避免了重复下载，使得定时更新非常快速高效。
*   **用户体验简化**: 用户的核心交互从“在长列表中选择”简化为“提供一个感兴趣的链接”，操作更直观。
*   **持久化配置**: 使用 `config.json` 使得用户的关注列表得以持久保存。

**负面**:
*   **状态管理**: 引入了 `config.json` 这个状态文件，需要确保脚本对其的读写操作是原子和安全的（虽然在当前单线程场景下风险很低）。
*   (同前一版) 依然存在对论坛前端变化的敏感性。
